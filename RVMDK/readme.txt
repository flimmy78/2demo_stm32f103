使用MINISTM32F103RBT6的板子测试PMSM程序按下面的接线顺序：

1、TIM1BKIN--------PB12      TIM1CH1-----------PA8
   TIM1CHIN--------PB13      TIM1CH2-----------PA9
   TIM1CH2N--------PB14      TIM1CH3-----------PA10
   TIM1CH3N--------PB15      TIM1CH4-----------PA11
  

2、TIM2的三个通道输入 = PA0、PA1、PA2 (没有FT,注意用DIODE保护)
   TIM3的二个通道输出 = PB4、PB5 可作为DA转换的PWM源 （REMAP功能）
   TIM4的二个通道输入 = PB8、PB9  ---------CH3、CH4  
   注意:凡是可以使用A/D的口线,都不是FT的.
3、PA3、PA4、PA5为三个A/D转换，采样2相电流和母线电压, PA6为散热
   温度,PA7为外部模拟电压输入,PB0,PB1为备用A/D输入.
   PA3------A PHASE
   PA4------B PHASE
   PB1------DC BUS 
   PB0------TEMP
   PA5、PA6、PA7被SPI1占用作为FLASH汉字库读写。
4、可以作为通用I/O的口线为：PB10、PB11、PA13、PA14、PA15、PB3可作为
   键盘输入和其他状态指示。PD2为LED,PC13为TFT背光。
   UP----PA15             DOWN------PB11
   LEFT----PA13           RIGHT-----PA14
   SEL-----PB10           
   
5、其他通讯口定义：PA11、PA12可以作为USB/CAN总线，PD2为LED指示，PB4,PB5为
   DA0,DA1。PB6,PB7为485口，PB8,PB9为TIM4的3、4输入捕捉通道。

5、需要处理的模块功能：
   MAX3232的RX1、TX1接到了PA9、PA10。
   发光LED-D2、D3为PA0、PA1，PA2为电位器调整。

6、如果口线可以调整，把TFT的驱动改为SPI或者4线方式，或者
   取消LCD，改用74HC595驱动的数码管显示。尽量增加有复用
   功能的口线，比如A/D或者通讯口的引脚。

=================================================================
DISPLAY_LCD使用的函数为:
 LCD_DisplayStringLine(Line0, ptr);
 LCD_ClearLine(Line2);
 LCD_SetTextColor(Blue);
 LCD_DisplayChar(Line4, (u16)(320 -(16*(18-i))),'-')
 LCD_DrawRect(161,97,1,2);
 核心函数: LCD_DrawChar(Line, Column, &ASCII_Table[Ascii * 24]);
========================================================================================
// When using Id = 0, NOMINAL_CURRENT is utilized to saturate the output of the 
// PID for speed regulation (i.e. reference torque). 
// Whit MB459 board, the value must be calculated accordingly with formula:
// NOMINAL_CURRENT = (Nominal phase current (A, 0-to-peak)*32767* Rshunt) /0.64
// 使用MB459时：  每A电流对应的A/D采样值（S16）=  Rshunt * Aop(电流增益 = 2.57）* 65536 / 3.3(V)
   电流可以为负值，所以使用S16，而不是U16    // =  Rshunt * 32767 / 0.64	  
											 //这里 0.64 = 1.65 / 2.57
// 同理如果使用ICS，那么电流增益为AV =62.5（mv/A), 	那么 每A电流对应的A/D采样值（S16）= 
// 电流可以为负值，所以使用S16，而不是U16，	Av * 65536 / 3.3 = Av * 32767 / 1.65 = 1241 (s16类型）
//						则该电流ICS可以采样的最大电流为 = 32767 / 1241 = 26.4（A)
// 如果Av = 1(V/A), 那么每A电流对应的A/D采样值（S16）= 32767 / 1.65 = 19858， 
// 则该电流ICS可以采样的最大电流为 = 32767 / 19858 = 1.65（A)
// 如果使用其他类型的电流传感器，那么电流增益的解释为：每变化1安培的电流，输出变化的电压值。
============================================================================================
老控制器接线：	 2009-8-15

1、使用HALL时：
 						  佳华				 合泰
    马达				  驱动器	         驱动器
	 HALL-黄			   HC				 HC
	 HALL-绿 		       HB				 HB
	 HALL-兰			   HA				 HA
	 C相-黄				   黄(A)			 W
	 B相-绿				   兰(B)			 V
	 A相-兰				   绿(C)			 U

2 、使用ENCODER:
    
	马达				  驱动器	         
	 A-绿			      HA				 
	 B-白 		          HB				 
	 Z-黄			      HC				 
	 C相-黄				   C				 
	 B相-绿				   B				 
	 A相-兰				   A				 
    
============================================================================================
新控制器接线： 2009-11-12
1、使用ENCODER:		 马达          驱动器
       ICS:     =============================
   		编码器：	   白		  	QEPA/HA
		               绿           QEPB/HB
					   黄           QEPZ/HC
				=============================		
		动力线：       A(兰)        U相
		               C(黄)        V相
					   B(绿)        W相
			    ==============================
2009-11-16 21:20
2、使用三电阻：		 马达          驱动器
				===============================
	 HALL：     	 蓝			   QEPA/HA
					 黄			   QEPB/HB
					 绿			   QEPZ/HC
				=============================
	动力线：	       C(兰)        U相
		               B(黄)        V相
					   A(绿)        W相
			    ==============================
======================================================================================
新控制器接线：  2009-11-13
1、使用ENCODER:		 马达          驱动器
       三电阻：   =============================
   		编码器：	   白		  	QEPA/HA
		               绿           QEPB/HB
					   黄           QEPZ/HC
				=============================
		动力线：       C(黄)        U相		  
		               B(兰)        V相
					   A(绿)        W相
			    ==============================
2009-11-16 21:20
2、使用三电阻：		 马达          驱动器
				===============================
	 HALL：     	 蓝			   QEPA/HA
					 黄			   QEPB/HB
					 绿			   QEPZ/HC
				=============================
	动力线：	       C(兰)        U相
		               B(黄)        V相
					   A(绿)        W相
			    ==============================

=======================================================================================
编码器：			  	QA=绿   QB=白				2009-11-13
三电阻：				BCA	 	OK	转向反			接线顺序为
ICS:					CAB	 	OK					从右――>左
						 							  U  V  W 
					   	ABC  	OK     
					
======================================================================================
编码器：               	QA=白   QB=绿				2009-11-13
三电阻：  				ACB		OK					接线顺序为
ICS:					CBA   	BEST				从右――>左
						   							 U  V  W 
						
						BAC     OK				    转向反
						
======================================================================================
ICS切换到三电阻模式需要修改的地方：

软件：
1、STM32F10x_MCconf.h的36、39行
2、MC_Control_Param.h的PWM_FREQ、MAX_MODULATION_100_PER_CENT、44和37行。
3、使用MMIvsPWMFreq.exe程序计算相关参数。

硬件：
1、把CPU板的J2插座上的第22、24脚外掰，不插入功率板的H1插座中。
2、把CPU板的J2插座上的第18脚连到CPU板的JP4插座的第2脚。
3、把CPU板的JP3插座左右短路。
==============================================================================
2009-11-18
原始PID参数适用于2500-4400转
Kp=150  Ki=20 Kd=0 ，适用于2500-4400
Kp=250   Ki=200 Kd=0,适用于1500-2500
Kp=100  Ki=20 Kd=0 ，适用于300
电机运行中取下电流传感器接线，有可能造成MOSFET损坏。
==============================================================================
2009-11-23
In theory, the higher the sampling rate, the better the regulation. In practice, you must keep 
in mind that:
● The related CPU load will grow accordingly.
● For speed regulation, there is absolutely no need to have a sampling time lower than 
the refresh rate of the speed information fed back by the external sensors; this 
becomes especially true when Hall sensors are used while driving the motor at low 
speed.		 No.122页，PMSM文档的122页。
===============================================================================
2009-11-24
不使用 IPMSM_MTPA选项，电机转速最高只能到4200RPM，加了该选项
可以到4800转。 所以
===============================================================================
/* if (HALL_SENSORS_PLACEMENT == DEGREES_120)
The sequence of the states is {STATE_5,STATE_1,STATE_3,STATE_2,STATE_6,STATE_4}
else if (HALL_SENSORS_PLACEMENT == DEGREES_60)
the sequence is {STATE_1,STATE_3,STATE_7,STATE_6,STATE_4,STATE_0}*/
================================================================================
天津王工送测电机有关参数如下 
1. 额定电压、  72V
       电流、  8.5A
       扭矩、  0.75 Nm
       转速、  7600 rpm
2. 峰值电流、17A
       扭矩、1.5Nm
       转速、6000rpm
3. 极对数、  2
   线电阻、0.27（1±10%）Ω
   线电感、0.87（1±10%）mH(10kHz)
   反电动势常数、0.083(1±10%) V/rad/s
   转动惯量:0.474kg.cm2
   电气常数:未测量
================================================================================
2009-12-14
TFT驱动程序需要换到LGDP4531上来，需要修改的函数为：
Lcd_WR_Start：写0x22寄存器，调用了DataToWrite
DataToWrite	：准备要写入的数据，不管是8位还是16位。
LCD_WR_REG	：先写寄存器，再写数据，调用了DataToWrite。

============================================================================================
第二版控制器接线： 2010-03-29
2010-03-29 12:10
2、使用三电阻：		 马达          驱动器	(右――左   PA0-PA1-PA2)
				===============================
	 HALL：     	 黄			   QEPA/HA	  (PA1)	  (中）
					 绿			   QEPB/HB	  (PA0)	 （右）
					 蓝			   QEPZ/HC	  (PA2)	 （左）
				=============================
	动力线：	       C(兰)        Y相
		               B(黄)        B相
					   A(绿)        R相
			    ==============================
======================================================================================
2010-4-1    14:54
使用三电阻：		 马达          驱动器  (右――左   PA0-PA1-PA2)
				===============================
	 ENC：     	     白			   QEPA/HA	  (PA1)	   (中）
					 绿			   QEPB/HB	  (PA0)	  （右）
					 黄			   QEPZ/HC	  (PA2)	  （左）
				=============================
	动力线：	       C(兰)        Y相
		               B(黄)        B相
					   A(绿)        R相
			    ==============================
======================================================================================
2010-4-2    16:10
使用ICS：		 马达          驱动器  (右――左   PA0-PA1-PA2)
				===============================
	 ENC：     	     白			   QEPA/HA	  (PA1)	   (中）
					 绿			   QEPB/HB	  (PA0)	  （右）
					 黄			   QEPZ/HC	  (PA2)	  （左）
				=============================
	动力线：	       C(蓝)        Y相
		               B(黄)        B相
					   A(绿)        R相
			    ==============================
======================================================================================
使用ICS：		 马达          驱动器  (右――左   PA0-PA1-PA2)
				===============================
	 HALL：    	     黄			   QEPA/HA	  (PA1)	   (中）
					 绿			   QEPB/HB	  (PA0)	  （右）
					 蓝			   QEPZ/HC	  (PA2)	  （左）
				=============================
	动力线：	       (蓝)        Y相
		               (绿)        B相
					   (黄)        R相
			    ==============================

使用ICS：		 马达          驱动器  (右――左   PA0-PA1-PA2)
				===============================
	 ENC：     	     白			   QEPA/HA	  (PA1)	   (中）
					 绿			   QEPB/HB	  (PA0)	  （右）
					 黄			   QEPZ/HC	  (PA2)	  （左）
				=============================
	动力线：	       C(蓝)        Y相
		               B(黄)        B相
					   A(绿)        R相
			    ==============================
========================================================================================						 
使用ICS：		 马达          驱动器  (右――左   PA0-PA1-PA2)
				===============================
	 HALL：    	     黄			   QEPA/HA	  (PA1)	   (中）
					 绿			   QEPB/HB	  (PA0)	  （右）
					 蓝			   QEPZ/HC	  (PA2)	  （左）
				=============================
	动力线：	       (黄)        Y相
		               (绿)        B相
					   (蓝)        R相
			    ==============================

使用ICS：		 马达          驱动器  (右――左   PA0-PA1-PA2)
				===============================
	 ENC：     	     白			   QEPA/HA	  (PA1)	   (中）
					 绿			   QEPB/HB	  (PA0)	  （右）
					 黄			   QEPZ/HC	  (PA2)	  （左）
				=============================
	动力线：	       C(黄)        Y相
		               B(黄)        B相
					   A(蓝)        R相
			    ==============================
========================================================================================						 
2010-6-17    16:30
使用ICS：		 马达          驱动器  (右――左   PA0-PA1-PA2)
				===============================
	 ENC：     	     绿			   QEPA/HA	  (PA1)	   (中）
					 白			   QEPB/HB	  (PA0)	  （右）
					 黄			   QEPZ/HC	  (PA2)	  （左）
				=============================
	动力线：	       C(蓝)        Y相
		               B(黄)        B相
					   A(绿)        R相
			    ==============================
======================================================================================


